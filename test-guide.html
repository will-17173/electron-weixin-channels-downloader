<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·æŒ‡å—åŠŸèƒ½æµ‹è¯•</title>
    <style>
        .test-container {
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        .test-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
        }
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .status.success { background: #e8f5e8; color: #2d5a2d; }
        .status.error { background: #ffeaea; color: #a94442; }
        .status.warning { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ§ª ç”¨æˆ·æŒ‡å—åŠŸèƒ½æµ‹è¯•</h1>

        <div class="test-section">
            <h2>ğŸ“‹ å½“å‰çŠ¶æ€</h2>
            <div id="status-container"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ”§ æµ‹è¯•æ“ä½œ</h2>
            <button class="test-button" onclick="clearStorage()">æ¸…é™¤å­˜å‚¨</button>
            <button class="test-button" onclick="checkMainApp()">æ£€æŸ¥ä¸»åº”ç”¨</button>
            <button class="test-button" onclick="simulateFirstLaunch()">æ¨¡æ‹Ÿé¦–æ¬¡å¯åŠ¨</button>
            <button class="test-button" onclick="manualTrigger()">æ‰‹åŠ¨è§¦å‘æŒ‡å—</button>
        </div>

        <div class="test-section">
            <h2>ğŸ“Š æµ‹è¯•ç»“æœ</h2>
            <div id="results-container"></div>
        </div>
    </div>

    <script>
        let results = [];

        function addStatus(message, type = 'info') {
            const container = document.getElementById('status-container');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = `${new Date().toLocaleTimeString()} - ${message}`;
            container.appendChild(div);
        }

        function addResult(test, result, details = '') {
            results.push({ test, result, details, time: new Date().toLocaleTimeString() });
            updateResults();
        }

        function updateResults() {
            const container = document.getElementById('results-container');
            container.innerHTML = results.map(r =>
                `<div class="status ${r.result ? 'success' : 'error'}">
                    ${r.time} - ${r.test}: ${r.result ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'} ${r.details}
                </div>`
            ).join('');
        }

        function clearStorage() {
            try {
                localStorage.removeItem('wxdown_first_launch_v1.1.0');
                localStorage.removeItem('wxdown_guide_settings');
                addStatus('âœ… å­˜å‚¨å·²æ¸…é™¤', 'success');
                addResult('æ¸…é™¤å­˜å‚¨', true);
            } catch (e) {
                addStatus('âŒ æ¸…é™¤å­˜å‚¨å¤±è´¥: ' + e.message, 'error');
                addResult('æ¸…é™¤å­˜å‚¨', false, e.message);
            }
        }

        function checkMainApp() {
            try {
                // æ£€æŸ¥ä¸»åº”ç”¨æ˜¯å¦åœ¨iframeä¸­æˆ–å¦ä¸€ä¸ªçª—å£
                if (window.parent !== window) {
                    addStatus('â„¹ï¸ æ£€æµ‹åˆ°iframeç¯å¢ƒ', 'warning');
                }

                // å°è¯•è®¿é—®ä¸»åº”ç”¨
                const mainWindow = window.open('http://localhost:5173/', '_blank');
                if (mainWindow) {
                    addStatus('âœ… ä¸»åº”ç”¨çª—å£å·²æ‰“å¼€', 'success');
                    addResult('æ‰“å¼€ä¸»åº”ç”¨', true);

                    // 5ç§’åæ£€æŸ¥çª—å£çŠ¶æ€
                    setTimeout(() => {
                        if (!mainWindow.closed) {
                            addStatus('â„¹ï¸ ä¸»åº”ç”¨ä»åœ¨è¿è¡Œ', 'info');
                        }
                    }, 5000);
                } else {
                    addStatus('âŒ æ— æ³•æ‰“å¼€ä¸»åº”ç”¨çª—å£', 'error');
                    addResult('æ‰“å¼€ä¸»åº”ç”¨', false, 'å¼¹çª—å¯èƒ½è¢«é˜»æ­¢');
                }
            } catch (e) {
                addStatus('âŒ æ£€æŸ¥ä¸»åº”ç”¨å¤±è´¥: ' + e.message, 'error');
                addResult('æ£€æŸ¥ä¸»åº”ç”¨', false, e.message);
            }
        }

        function simulateFirstLaunch() {
            try {
                // å…ˆæ¸…é™¤å­˜å‚¨
                localStorage.removeItem('wxdown_first_launch_v1.1.0');
                localStorage.removeItem('wxdown_guide_settings');

                // æ‰“å¼€ä¸»åº”ç”¨è¿›è¡Œæµ‹è¯•
                const testWindow = window.open('http://localhost:5173/', 'firstLaunchTest');
                if (testWindow) {
                    addStatus('âœ… é¦–æ¬¡å¯åŠ¨æµ‹è¯•çª—å£å·²æ‰“å¼€', 'success');
                    addResult('æ¨¡æ‹Ÿé¦–æ¬¡å¯åŠ¨', true);

                    // ç›‘å¬çª—å£åŠ è½½
                    const checkInterval = setInterval(() => {
                        try {
                            if (testWindow.closed) {
                                clearInterval(checkInterval);
                                addStatus('â„¹ï¸ æµ‹è¯•çª—å£å·²å…³é—­', 'info');
                                return;
                            }

                            // å°è¯•æ£€æŸ¥çª—å£ä¸­çš„å…ƒç´ 
                            const guideOverlay = testWindow.document.querySelector('.user-guide-overlay');
                            if (guideOverlay) {
                                const isVisible = testWindow.getComputedStyle(guideOverlay).display !== 'none';
                                addStatus(isVisible ? 'âœ… æ£€æµ‹åˆ°æŒ‡å—å·²æ˜¾ç¤º' : 'âš ï¸ æŒ‡å—å…ƒç´ å­˜åœ¨ä½†ä¸å¯è§',
                                         isVisible ? 'success' : 'warning');
                                addResult('é¦–æ¬¡å¯åŠ¨æŒ‡å—æ˜¾ç¤º', isVisible);
                                clearInterval(checkInterval);
                            }
                        } catch (e) {
                            // è·¨åŸŸè®¿é—®é™åˆ¶ï¼Œè¿™æ˜¯æ­£å¸¸çš„
                        }
                    }, 1000);

                    // 10ç§’ååœæ­¢æ£€æŸ¥
                    setTimeout(() => {
                        clearInterval(checkInterval);
                    }, 10000);
                } else {
                    addStatus('âŒ æ— æ³•æ‰“å¼€æµ‹è¯•çª—å£', 'error');
                    addResult('æ¨¡æ‹Ÿé¦–æ¬¡å¯åŠ¨', false, 'çª—å£è¢«é˜»æ­¢');
                }
            } catch (e) {
                addStatus('âŒ æ¨¡æ‹Ÿé¦–æ¬¡å¯åŠ¨å¤±è´¥: ' + e.message, 'error');
                addResult('æ¨¡æ‹Ÿé¦–æ¬¡å¯åŠ¨', false, e.message);
            }
        }

        function manualTrigger() {
            try {
                // æ‰“å¼€ä¸»åº”ç”¨å¹¶å°è¯•æ‰‹åŠ¨è§¦å‘
                const testWindow = window.open('http://localhost:5173/', 'manualTriggerTest');
                if (testWindow) {
                    addStatus('âœ… æ‰‹åŠ¨è§¦å‘æµ‹è¯•çª—å£å·²æ‰“å¼€', 'success');

                    // ç­‰å¾…é¡µé¢åŠ è½½
                    setTimeout(() => {
                        try {
                            // å°è¯•ç‚¹å‡»æŒ‡å—æŒ‰é’®
                            const button = testWindow.document.querySelector('.guide-button');
                            if (button) {
                                button.click();
                                addStatus('âœ… å·²ç‚¹å‡»æŒ‡å—æŒ‰é’®', 'success');
                                addResult('æ‰‹åŠ¨è§¦å‘æŒ‡å—', true);
                            } else {
                                addStatus('âŒ æ‰¾ä¸åˆ°æŒ‡å—æŒ‰é’®', 'error');
                                addResult('æ‰‹åŠ¨è§¦å‘æŒ‡å—', false, 'æŒ‰é’®ä¸å­˜åœ¨');
                            }
                        } catch (e) {
                            addStatus('âš ï¸ è·¨åŸŸé™åˆ¶ï¼Œæ— æ³•ç›´æ¥æ“ä½œ', 'warning');
                            addResult('æ‰‹åŠ¨è§¦å‘æŒ‡å—', false, 'è·¨åŸŸé™åˆ¶');
                        }
                    }, 2000);
                } else {
                    addStatus('âŒ æ— æ³•æ‰“å¼€æµ‹è¯•çª—å£', 'error');
                    addResult('æ‰‹åŠ¨è§¦å‘æŒ‡å—', false, 'çª—å£è¢«é˜»æ­¢');
                }
            } catch (e) {
                addStatus('âŒ æ‰‹åŠ¨è§¦å‘å¤±è´¥: ' + e.message, 'error');
                addResult('æ‰‹åŠ¨è§¦å‘æŒ‡å—', false, e.message);
            }
        }

        // åˆå§‹åŒ–æ£€æŸ¥
        function initialize() {
            addStatus('ğŸ” æµ‹è¯•é¡µé¢å·²åŠ è½½', 'info');

            // æ£€æŸ¥localStorage
            const firstLaunch = localStorage.getItem('wxdown_first_launch_v1.1.0');
            const guideSettings = localStorage.getItem('wxdown_guide_settings');

            addStatus(`é¦–æ¬¡å¯åŠ¨æ ‡è®°: ${firstLaunch || 'æœªè®¾ç½®'}`, firstLaunch ? 'warning' : 'info');
            addStatus(`æŒ‡å—è®¾ç½®: ${guideSettings || 'æœªè®¾ç½®'}`, guideSettings ? 'info' : 'info');

            // æ£€æŸ¥ä¸»åº”ç”¨è¿æ¥
            fetch('http://localhost:5173/')
                .then(response => {
                    if (response.ok) {
                        addStatus('âœ… ä¸»åº”ç”¨æœåŠ¡å™¨è¿æ¥æ­£å¸¸', 'success');
                        addResult('æœåŠ¡å™¨è¿æ¥', true);
                    } else {
                        addStatus('âš ï¸ ä¸»åº”ç”¨æœåŠ¡å™¨å“åº”å¼‚å¸¸', 'warning');
                        addResult('æœåŠ¡å™¨è¿æ¥', false, `çŠ¶æ€ç : ${response.status}`);
                    }
                })
                .catch(e => {
                    addStatus('âŒ æ— æ³•è¿æ¥ä¸»åº”ç”¨æœåŠ¡å™¨', 'error');
                    addResult('æœåŠ¡å™¨è¿æ¥', false, e.message);
                });
        }

        // é¡µé¢åŠ è½½ååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
